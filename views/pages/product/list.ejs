<!DOCTYPE html>
<html lang="en">

<head>
  <%- include('../../partials/head', {pageTitle: pageTitle}); %>
    <style>
      .table th {
        text-align: center;
      }
    </style>

</head>

<body id="page-top">

  <!-- Page Wrapper -->
  <div id="wrapper">

    <!-- Sidebar -->
    <%- include('../../partials/sidebar', {siteName: siteName}); %>
      <!-- End of Sidebar -->

      <!-- Content Wrapper -->
      <div id="content-wrapper" class="d-flex flex-column">

        <!-- Main Content -->
        <div id="content">

          <!-- Topbar -->
          <%- include('../../partials/header', {siteName: siteName, userFullName: userFullName, userImage: userImage});
            %>
            <!-- End of Topbar -->

            <!-- Begin Page Content -->
            <div class="container-fluid">

              <h1 class="h3 mb-2 text-gray-800"><%-pageName%></h1>
              <p class="mb-4">View / edit <%-pageName%> details</p>
              <div class="card shadow mb-4">
                <div class="card-header py-3">
                  <h6 class="m-0 font-weight-bold text-primary"><%-pageName%> Details</h6>
                  <div>
                    <button id="downloadExcelBtn" class="btn btn-primary">Download Excel</button>
                    <div class="search-container">
                      <form>
                        <div class="searchlist-rowbox">
                          <div class="fld-part">
                            <select id="categorySelect" class="custom-select sr-field" required>
                              <option selected>Select Category</option>
                              <option value="name">Name</option>
                              <option value="brand_name">Brand Name</option>
                              <option value="user_name">User Name</option>
                              <option value="size_name">Size</option>
                              <option value="productCondition_name">Condition</option>
                              <option value="approval_status">Approval Status</option>
                            </select>

                            <input type="text" placeholder="Product Name" id="productNameInput" class="sr-field">
                          </div>
                          <div class="sb-box"><button type="button" onclick="searchNow()" placeholder="Submit"
                              class="sr-button">Search Now</button>
                          </div>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-bordered"  id="dataTable" width="100%" cellspacing="0">
                      <thead>
                        <tr>
                          <th>Sl No</th>
                          <th>Product Images</th>
                          <th>Product Name</th>
                          <th>Category</th>
                          <th>SubCategory</th>
                          <th>Brand</th>
                          <th>Size</th>
                          <th>Username</th>
                          <th>Condition</th>
                          <th>Offer Price</th>
                          <th>Item Status</th>
                          <th>Approval Status</th>
                          <th>Created On</th>
                          <th>Action</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% if (respdata.list) { %>
                          <% respdata.list.forEach(function (value, index) { %>
                            <tr>
                              <td>
                                <%= (index + 1) %>
                              </td>
                              <td>
                                <%  value.productImages.forEach(function(image) { %>
                                  <% if (/^(ftp|http|https):\/\/[^ "]+$/.test(image.image)) { %>
                                    <% const imagePathParts = image.image.split('/public/images/'); %>
                                    <% if (imagePathParts.length > 1) { %>

                                      <img src=" <%=requrl %>/public/images/<%= imagePathParts[1] %>" style="height:
                                      67px; width: 100px;">
                                      <% } else { %>

                                        <img src="<%= requrl %>/public/compress_images/<%= image.image %>"
                                          style="height: 67px; width: 100px;">
                                        <% } %>
                                          <% } else { %>
                                            <img src="<%= requrl %>/public/images/<%= image.image %>"
                                              style="height: 67px; width: 100px;">
                                            <% } %>

                                              <% }); %>

                              </td>
                              <td>
                                <%= value.name || 'Name not available' %>
                              </td>
                              <td>
                                <%= value.category && value.category.parent && value.category.parent.length> 0 ?
                                  value.category.parent[0].name : 'Not found' %>
                              </td>
                              <td>
                                <%= value.category && value.category.name || 'Category not available' %>
                              </td>
                              <td>
                                <%= value.brand && value.brand.length> 0 ? value.brand[0].name : 'Brand not found' %>
                              </td>
                              <td>
                                <%= value.size && value.size.length> 0 ? value.size[0].name : 'Size not found' %>
                              </td>
                              <% if(value.user){%>
                                <td>
                                  <%=value.user.name;%>
                                </td>
                                <%} else{%>
                                  <td>
                                    User Not Found!
                                  </td>
                                  <%}%>
                                    <td>
                                      <%= value.productCondition && value.productCondition.length> 0 ?
                                        value.productCondition[0].name : 'Condition not found' %>
                                    </td>
                                    <td>
                                      <%= value.offer_price %>
                                    </td>
                                    <td>
                                      <% if (value.flag===0) { %>
                                        Not set yet
                                        <% } else if (value.flag===1) { %>
                                          WHAT'S HOT
                                          <% } else if (value.flag===2) { %>
                                            Best Deal
                                            <% } else if (value.flag===3) { %>
                                              Just SOLD
                                              <% } else { %>
                                                Unknown
                                                <% } %>
                                    </td>
                                    <td>
                                      <% if (value.approval_status===0) { %>
                                        <span style="color: blue;">Pending</span>
                                        <% } else if (value.approval_status===1) { %>
                                          <span style="color: green;">Approved</span>
                                          <% } else if (value.approval_status===2) { %>
                                            <span style="color: red;">Rejected</span>
                                            <% } else { %>
                                              Unknown
                                              <% } %>
                                    </td>
                                    <td>
                                      <%= value.added_dtime || 'Date not available' %>
                                    </td>
                                    <td>
                                      <a href="/admin/productdetails/<%= value._id %>" class="btn btn-info btn-circle btn-sm"
                                        title="Edit">
                                        <i class="fas fa-pencil-alt"></i>
                                      </a>
                                      <a href="/admin/delete-product/<%= value._id %>"
                                        class="btn btn-danger btn-circle btn-sm" title="Delete"
                                        onclick="return confirm('Are you sure you want to delete this item?')">
                                        <i class="fas fa-trash"></i>
                                      </a>

                                    </td>
                            </tr>
                            <% }); %>
                              <% } %>
                      </tbody>
                    </table>
                  </div>
                  <hr>

                </div>
              </div>
            </div>
        </div>
        <%- include('../../partials/footer', {year: year, siteName: siteName}); %>
      </div>
  </div>
  <a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
  </a>
  <%- include('../../partials/logoutModal'); %>
    <%- include('../../partials/footerJs'); %>
</body>
<script>
  $(document).ready(function () {
    $('#dataTable').DataTable({
      "paging": true,
      "ordering": true,
      "searching": true
    });

    document.getElementById('downloadExcelBtn').addEventListener('click', function() {
    window.location.href = '/admin/download-product-excel';
  });
  });
</script>

</html>
<script>

  function searchNow() {
    var selectedCategory = $('#categorySelect').val();
    var productName = $('#productNameInput').val();
    var page = 1;
    let url = '/admin/productlist?';
    if (page && !isNaN(page)) {
      url = url + 'page=' + page;
    }
    if (selectedCategory && (selectedCategory !== '')) {
      url = url + '&searchType=' + selectedCategory;
    }
    if (productName && (productName !== '')) {
      url = url + '&searchValue=' + productName;
    }
    window.location.href = url;

    $.ajax({
      url: `/admin/productlist`,
      type: 'GET',
      data: {
        page: page,
        searchType: selectedCategory,
        searchValue: productName,
      },
      success: function (response) {
      },
      error: function (error) {
      }
    });

  }

  function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
      results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
  }

  var page = getParameterByName('page');
  var searchType = getParameterByName('searchType');
  var searchValue = getParameterByName('searchValue');

  if (searchType) {
    $('#categorySelect').val(searchType);
  }

  if (searchValue) {
    $('#productNameInput').val(searchValue);
  }
</script>